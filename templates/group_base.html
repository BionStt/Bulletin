{% extends "base.html" %}

{# comment: load custom gravatar filter #}
{% load gravatar %}

{% block body %}
<div class="navbar">
    <div class="navbar-inner">
  	    <div class="container">
            <a class="brand" href="#">Bulletin</a>
            <ul class="nav pull-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <img class="avatar pull-left" src="{{ user.email|gravatar:'30' }}" alt="author's gravatar" />
                        <span>{{ user.first_name }} {{ user.last_name }}</span>
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="#change-password" data-toggle="modal">Change Password</a>
        	            <li><a href="/logout">Logout</a>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</div>

{% block content %}
<div id="top" class="row-fluid">
	<div class="container-narrow">
		<div class="span3">
			<div id='left-column' class="well">
				{% block nav %}
				<ul id="team-nav" class="nav nav-list">
				    <li {% if not group %} class="active" {% endif %} ><a href="/"><i class="icon-inbox"></i> Inbox</a></li>
				    <li class="nav-header">Groups</li>
				    {% for member in user.membership_set.all %}
				    <li {% ifequal group.pk member.group.id %} class="active" {% endifequal %}>
				        <a href="/group/{{ member.group.id }}/">
				            {{ member.group.name }}
				        </a>
				    </li>
				    {% endfor %}
				</ul>
			    <a class="btn btn-block" href="#create-group" data-toggle="modal"><i class="icon-plus"></i> New Group</a>

                <!-- REMOVE THIS ASAP -->
                <style>
                    .remove-btn {
                        color: #777;
                        visibility: hidden;
                    }

                    li:hover .remove-btn {
                        visibility: visible;
                    }

                    .remove-btn:hover {
                        cursor: pointer;
                        color: red;
                    }

                    .btn {
                        margin-top: .5em;
                    }
                </style>
                {% if group %}
                <ul class="nav nav-list">
                    <li class="divider"></li>
                    <li class="nav-header">Group Members</li>
                    {% for member in group.members.all %}
                    <li>
                        <span class="member-name" memid="{{ member.pk }}">{{ member.get_full_name }}</span>
                        {% if is_admin and member != user %}
                        <i class="remove-btn remove-user icon-trash"></i></a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if is_admin %}
                <a href="#invite-people" class="btn btn-block" data-toggle="modal"><i class="icon-user"></i> Invite To Group</a>
                <ul class="nav nav-list">
                    <li class="divider"></li>
                    <li class="nav-header">Active Invites</li>
                    {% if invites %}
                        {% for invite in invites %}
                            {% if invite.acceptance == 'P' %}
                            <li style="font-size: .7em;">{{ invite.recipient_email }} (Pending)
                            {% elif invite.acceptance == 'A' %}
                            <li style="font-size: .7em; color: green;">{{ invite.recipient_email }} (Accepted)
                            {% else %}
                            <li style="font-size: .7em; color: red;">{{ invite.recipient_email }} (Rejected)
                            {% endif %}
                        <i class="remove-btn remove-invite icon-remove"></i></li>
                        {% endfor %}
                    {% else %}
                    <li>0 invites</li>
                    {% endif %}
                </ul>
                {% endif %}
                <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
                <script>
                    $(document).ready(function() {
                        $(".remove-user").click(function() {
                            var user_name = $(this).prev(".member-name").html();
                            var member_id = $(this).prev(".member-name").attr("memid");
                            $("#remove-user-confirm").find("#user-name-here").html(user_name);
                            $("#remove-user-confirm").find("#user-name-here").attr("memid", member_id);
                            $("#remove-user-confirm").modal();
                        });

                        $("#remove-user-btn").click(function() {
                            $(this).attr("disabled", "disabled");
                            var member_id = $(this).parents("#remove-user-confirm").find("#user-name-here").attr("memid");
                            $.ajax({
                                url: "/membership/" + member_id + "/remove/",
                                error: function(data) {alert("failed to delete user");},
                                success: function(){},
                                complete: function() {
                                    $("#remove-user-btn").removeAttr("disabled");
                                    $(".member-name[memid='" + member_id + "']").parent().hide();
                                    $("#remove-user-confirm").modal('hide');
                                }
                            });
                        });

                        $(".remove-invite").click(function() {
                            $(this).parent().hide();
                        });
                    });
                </script>

				{% endblock nav %}
			</div>
		</div>
		<div id="content-container" class="span9">
			<div class="hero-unit">
				<div id="content">
					{% block maincontent %}
					<p>No Content</p>
					{% endblock maincontent %}
				</div>
			</div>
			<div id="footer" class='pull-right'>Whitespace</div>
		</div>
	</div>
</div>

{% if is_admin %}
    {% include "group_invite_modal.html" %}
    {% include "group_remove_member_modal.html" %}
{% endif %}
{% include "group_create_modal.html" with csrf_token=csrf_token only %}
{% include "password_change_modal.html" with csrf_token=csrf_token only %}

<div id="jump-top" class="hide well"><i class="icon-arrow-up"></i></div>
{% endblock content %}

{% endblock body %}

{% block extrajs %}
<script src="{{ STATIC_URL }}js/create-group.js"></script>
<script src="{{ STATIC_URL }}js/paragraph-filter.js"></script>
<script src="{{ STATIC_URL }}js/change-password.js"></script>
{% if is_admin %}<script src="{{ STATIC_URL }}js/group-invite.js"></script>{% endif %}
{% endblock extrajs %}
