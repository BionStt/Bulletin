{% extends "group_base.html" %}

{# comment: load custom gravatar filter #}
{% load gravatar %}

{% block maincontent %}
<form id="post_form" method="post" class="clearfix">
    <textarea class="input-block-level" placeholder="Communicate with your team..." id="id_message" rows="10" cols="40" name="message"></textarea>
	<input type="submit" value="Post" class="btn" />
    {% csrf_token %}
</form>

{% if post_list %}
<ul id="posts" class="media-list">
    {% for post in post_list %}
    <li class="media post">
        <img class="avatar pull-left media-object" src="{{ post.author.user.email|gravatar:'50' }}" alt="author's gravatar" />
        <div class="media-body">
            <span class="media-heading clearfix">
                <strong class="pull-left">{{ post.author.user.first_name }} {{ post.author.user.last_name }}</strong>
                <em class="pull-right">{{ post.time_stamp }}</em>
                <span class="pull-right spacing-right">
                    <a href="javascript:void(0)" class="comment-unhide-btn">Comment</a>
                </span>
                <br />
            </span>
            <div class="post-message">{{ post.message }}</div>
	        {% if post.comment_set.all %}
            <ul class="media-list comments">
            {% for comment in post.comment_set.all %}
            <li class="media comment">
                <img class="avatar pull-left media-object" src="{{ comment.author.user.email|gravatar:'50' }}" alt="commenters's gravatar" />
                <div class="media-body">
	                <span class="media-heading clearfix">
	                    <strong class="pull-left">{{ comment.author.user.first_name }} {{ comment.author.user.last_name }}</strong>
	                    <em class="pull-right">{{ comment.time_stamp }}</em>
	                    <br />
	                </span>
	                <div class="comment-message">{{ comment.message }}</div>
                </div>
            </li>
            {% endfor %}
            </ul>
	        {% endif %}
	        <div class="comment-form-container well-small well clearfix hide">
	            <img class="avatar pull-left" src="{{ user.email|gravatar:'30' }}" alt="user's gravatar" />
		        <form method="post" class="clearfix comment-form">
				    {% csrf_token %}
				    <input type="text" placeholder="Comment on this post" id="id_message" name="comment" class="pull-left spacing-right" autocomplete="off" />
                    <input type='hidden' name='id_post' value='{{ post.pk }}' />
				    <input type="submit" value="Comment" class="btn pull-left" />
				</form>
			</div>
		</div>
    </li>
    {% endfor %}
</ul>
{% else %}
<div class="alert alert-error">
    No posts are available.
</div>
{% endif %}
{# --- #}
<!--<script src="http://code.jquery.com/jquery-latest.js"></script>
<script>
$(document).ready(function() {
    $('#post_form').submit(function(e) {
        e.preventDefault();

        var form = $(this);
        var url = 'post/';
        var msg = form.find('#id_message').val();
        var csrf = form.find('input[name="csrfmiddlewaretoken"]').val();


        $.post(url, {message: msg, csrfmiddlewaretoken: csrf}, function(data) {
            form.find('#id_message').val('');
            alert(data);
        }, 'json');
    });
});
</script>-->
{# --- #}
{% endblock maincontent %}

{% block extrajs %}
<script src="/static/js/md5.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function() {
    // comment slider
    $('.comment-unhide-btn').click(function(event) {
    	var $commentForm;
        var $post;
        
        event.preventDefault();
        $post = $(this).parents('.post');
        $commentForm = $post.find(".comment-form-container");
        $(this).parent().fadeOut();
        $commentForm.show("blind", function() {
            $('html, body').animate({
                scrollTop: $post.offset().top - $('.navbar').height()
            }, 500);
        });
    });

    // comment ajax
    $('.comment-form').submit(function(event) {
        event.preventDefault();

        var form = $(this);
        var url = 'post/' + form.find('input[name="id_post"]').val() + '/comment/';
        var msg = form.find('#id_message').val();
        var csrf = form.find('input[name="csrfmiddlewaretoken"]').val();


        $.post(url, {message: msg, csrfmiddlewaretoken: csrf}, function(data) {
            // copy of message is returned via json, insert into page
            comment_html = "<div class=\"comment\"> \
                    <p> \
                        <img class=\"avatar pull-left\" src=\"http://www.gravatar.com/avatar/" + md5(data.author.email) + "?s=50&d=mm" + "\" alt=\"commenters's gravatar\" /> \
                        <span> \
                            <strong>" + data.author.first_name + data.author.last_name + "</strong> \
                            <em class=\"pull-right\">" + data.date_posted + "</em> \
                            <br /> \
                        </span> \
                        " + data.message + " \
                    </p> \
                </div>";
            form.parent().before(comment_html);
            form.find("#id_message").val("");
        }, 'json');
    });
});
</script>
{% endblock extrajs %}
